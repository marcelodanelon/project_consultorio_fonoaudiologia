{% extends 'global/base.html' %}

{% block nav_lateral %}
  {% include 'partials/_nav_estoque.html' %}
{% endblock nav_lateral %}

{% block head_base %}
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap" rel="stylesheet">
<style>
  .btn-movimentacao {
    border: none;
    background: none;
    width: 60px; 
    height: 60px; 
    margin: 0 10px;
    transition: all 0.3s ease; 
  }
  .btn-movimentacao:hover {
    transform: scale(1.2); 
  }
  .btn-historico {
    border: none;
    background: none;
    width: 50px; 
    height: 50px; 
    margin: 0 10px;
    transition: transform 0.3s ease; 
  }
  .btn-historico:hover {
    transform: translateX(-10px); 
  }
  #img-place-cards{
    display: flex; 
    flex-direction: column; 
    justify-content: center; 
    align-items: center; 
    height: 80vh;
    font-family: 'Nunito', sans-serif;
  }
  #img-place-cards.active {
    display: flex; 
    flex-direction: column; 
    justify-content: center; 
    align-items: center; 
    height: 80vh;
  }
</style>
<script>
$(document).ready(function($) {

})
</script>
{% endblock head_base %}

{% block content %}
<form id="form-movimentacao" action="{{form_action}}" method="post">
  {% csrf_token %}
  <div style="height: 90vh; width: 82vw; position: relative;">
    <div class="row">
      <div style="margin-left:1%; background: white; width: 35vw; height: 89vh;box-shadow: 0px 0px 10px 5px rgba(0, 0, 0, 0.1);">
        <div style="margin-top:1vh;">
          <div class="row">
            <div class="col">
              {{formMovimentacao.data.label}}
              {{formMovimentacao.data}}   
            </div>
            <div class="col">
              {{formMovimentacao.local.label}}
              {{formMovimentacao.local}}    
            </div>
          </div>
        </div> 
        <div style="margin-top:1vh;">
          {{formMovimentacao.tipoMovimentacao.label}}
          {{formMovimentacao.tipoMovimentacao}}    
        </div>
        <div hidden style="margin-top:1vh;">
          <input id="id_operacao" name="operacao" type="text">   
        </div>
        <div style="margin-top:1vh;" hidden>
          {{formMovimentacao.eClient.label}}
          {{formMovimentacao.eClient}}    
        </div>
        <div style="display: flex; justify-content: center; align-items: center; height: 200px;">
          <button title='Entrada' class="btn-movimentacao" type="button" id="btn-entrada">
            <img src="/media/estoque/btn-icon-entrada.png">
          </button>
          <button title='Saída' class="btn-movimentacao" type="button" id="btn-saida">
            <img src="/media/estoque/btn-icon-saida.png">
          </button>
        </div>
        <div style="position: absolute; bottom: 2vh; width: 34vw;">
          {{formMovimentacao.observacao.label}}
          {{formMovimentacao.observacao}}    
        </div>
      </div>
      <div style="padding:1%; margin-left:1%; background: white; width: 45vw; height: 89vh;box-shadow: 0px 0px 10px 5px rgba(0, 0, 0, 0.1);overflow-y:auto;">
        <div id="img-place-cards">
          <span style="margin-bottom: 10px;"><b>Vamos começar a Movimentar!</b></span>
          <img src="/media/estoque/estoque.png" alt="estoque">
        </div>
        <div hidden id="card-entrada" style="margin-top:1vh;">
          <h5>ENTRADA DE INSUMOS</h5>
          {% include 'estoque/movimentacao_new/pages_movimentacao/entrada_de_insumos.html' %}
        </div>
        <div hidden id="card-saida" style="margin-top:1vh;">
          <h5>SAÍDA DE INSUMOS</h5>
          <div class="text-end">
              <h5 id="message" style="color: #007BFF; font-family: 'Arial', sans-serif; font-size: 18px;"></h5>
          </div>
          {% include 'estoque/movimentacao_new/pages_movimentacao/saida_de_insumos.html' %}
        </div>
      </div>
    </div>
    <button class="btn-movimentacao"style="display: inline-block; position: absolute; bottom: 1vh; right: 1vw; height:80px; width:80px;">
      <img src="/media/btn-gravar.png">
    </button>
  </div>  
</form>
<script>
$(document).ready(function(){
  // desabilita botões de movimentação ENTRADA / SAÍDA até que seja selecionado um local
  $('#id_local').on('change', function(){
    if ($('#id_local').val() == '') {
      $('#btn-entrada').prop('hidden', true);
      $('#btn-saida').prop('hidden', true);
      $('#card-entrada').prop('hidden', true);
      $('#card-saida').prop('hidden', true);
      $('#img-place-cards').prop('hidden', false);
    } else {
      $('#btn-entrada').prop('hidden', false);
      $('#btn-saida').prop('hidden', false);
    }
  });
  $('#id_local').trigger('change');

  // controle exibição de cards no place
  $('#btn-entrada').on('click', function(){
    var divEntrada = document.getElementById('card-entrada'); 

    if (divEntrada && divEntrada.hidden) {
      $('#card-entrada').prop('hidden', false);
      $('#card-saida').prop('hidden', true);
      $('#img-place-cards').prop('hidden', true);
      $('.form-row-entrada').find(':input').each(function() {
        $(this).prop('required', true);
      }); 
      $('.form-row-entrada').find('[name$=-DELETE]').each(function() {
        $(this).prop('required', false);
      });
      $('.form-row-saida').find(':input').each(function() {
        $(this).prop('required', false);
      }); 
    } else {
      $('#card-entrada').prop('hidden', true);
      $('#card-saida').prop('hidden', true);
      $('#img-place-cards').prop('hidden', false);
    }

    // limpando card de SAIDAS caso alterado para operacao tipo SAIDA
    var conditionRow = $('.form-row-saida:not(:first)');
    conditionRow.remove()
    $('.form-row-saida').find(':input').each(function() {
      var nameCampo = $(this).attr('name');
      if (!(nameCampo && (nameCampo.endsWith('-dataEntrada') || nameCampo.endsWith('-valorTotal') || nameCampo.endsWith('-dataValidade')))) {
        $(this).val('');
      }
    });
    $('.form-row-saida').find('select').each(function() {
      var id = $(this).attr('id');
      if (id && id.endsWith('myItems')) {
        $(this).empty();
      }
      $(this).prop('selectedIndex', 0);
    });

    // se clicado em entrada, atribui 'entrada' para o campo input 'id_operacao'
    $('#id_operacao').val('Entrada') 
    
    //ajuste layout para opçao de SAIDA
    $('[id$=-valorUnitario]').prop( "readonly", false );
  })

  $('#btn-saida').on('click', function(){
    var divSaida = document.getElementById('card-saida'); 

    if (divSaida && divSaida.hidden) {
      $('#card-saida').prop('hidden', false);
      $('#card-entrada').prop('hidden', true);
      $('#img-place-cards').prop('hidden', true);
      $('.form-row-saida').find(':input').each(function() {
        $(this).prop('required', true);
      }); 
      $('.form-row-saida').find('[name$=-DELETE]').each(function() {
        $(this).prop('required', false);
      });
      $('.form-row-entrada').find(':input').each(function() {
        $(this).prop('required', false);
      }); 
    } else {
      $('#card-saida').prop('hidden', true);
      $('#card-entrada').prop('hidden', true);
      $('#img-place-cards').prop('hidden', false);
    }

    // limpando card de ENTRADA caso alterado para operacao tipo ENTRADA
    var conditionRow = $('.form-row-entrada:not(:first)');
    conditionRow.remove()
    $('.form-row-entrada').find(':input').each(function() {
      var nameCampo = $(this).attr('name');
      if (!(nameCampo && (nameCampo.endsWith('-dataEntrada') || nameCampo.endsWith('-valorTotal') || nameCampo.endsWith('-dataValidade')))) {
        $(this).val('');
      }
      if (nameCampo && nameCampo.endsWith('-valorCompra')){
        $(this).prop('readonly', true);
      }
    });    
    $('.form-row-entrada').find('select').each(function() {
      $(this).prop('selectedIndex', 0);
    });  

    // se clicado em saída, atribui 'saida' para o campo input 'id_operacao'
    $('#id_operacao').val('Saída')   

    //ajuste layout para opçao de SAIDA
    $('[id$=-valorUnitario]').prop( "readonly", true );
  })

  // desabilita o envio dos campos da outra movimentacao
  $('#form-movimentacao').submit(function(){
    operacao = $('#id_operacao').val()
    if (operacao == 'Saída'){
      $('#card-entrada :input').prop('disabled', true);
    }else{
      $('#card-saida :input').prop('disabled', true);
    }
  });
})
</script>
{% endblock content %}
