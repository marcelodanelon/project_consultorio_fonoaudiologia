{% load custom_template_tag %}
{% for fieldClient in client %}
    <div class="card_client">
        <div class="row">
            <div class="col-4">
                Nome: {{fieldClient.first_name}} {{fieldClient.last_name}}
            </div>
            <div class="col-4">
                {% if fieldClient.street == None or fieldClient.number == None or fieldClient.district == None %}
                    EndereÃ§o: Incompleto
                {% else %}
                    EndereÃ§o: {{fieldClient.street}}, {{fieldClient.number}} - {{fieldClient.district}} - CEP:{{fieldClient.zipcode}} {{fieldClient.city}}/{{fieldClient.state}}
                {% endif %}
            </div>
            <div class="col-2">
                {% if fieldClient.age == None %}
                    Idade: 
                {% else %}
                    Idade: {{fieldClient.age}} Anos
                {% endif %}
            </div>
        </div>
        <div class="row">
            <div class="col-2">
                {% if fieldClient.phone1 == None %}
                    Telefone: NÃ£o Informado
                {% else %}
                    Telefone: {{fieldClient.phone1}}
                {% endif %}
            </div>
            <div class="col-2">
                {% if fieldClient.phone1 == None %}
                    Recado: NÃ£o Informado
                {% else %}
                    Recado: {{fieldClient.phone2}}
                {% endif %}
            </div>
            <div class="col-4">
                {% if fieldClient.profession == None %}
                    ProfissÃ£o: NÃ£o Informado
                {% else %}
                    ProfissÃ£o: {{fieldClient.profession}}
                {% endif %}
            </div>
            <div class="col-2">
                {% if fieldClient.document1 == None %}
                    CPF: 
                {% else %}
                    CPF: {{fieldClient.document1}}
                {% endif %}
            </div>
            <div class="col-2">
                {% if fieldClient.document2 == None %}
                    RG: 
                {% else %}
                    RG: {{fieldClient.document2}}
                {% endif %}
            </div>
        </div>
    </div>
{% endfor %}
{% for field in form %} 
    {% if field.name == 'aClient' or field.name == 'aProfessional' or field.name == 'aConhece' or field.name == 'aOuviMel' %}  
        <div class="row align-items-center">
        {% setvar "yes" as action %}
    {% endif %} 
    {% if field.name == "aTelevis" %}
        {% setvar "no" as action %}
    {% endif %}
    {% if action == "yes" %}
        {% if field.name == 'aClient' %}
            <div class="col">                 
                <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label> <br>
                <div class="input-group">
                    <div style="width: 300px !important;">
                        <input type="text" class="form-control" placeholder="Digite um nome" id="input_aClient" name="input_aClient">
                    </div>
                    {{field}}
                    <div class="input-group-append">
                        <button id="searchButtonCliente" class="btn btn-outline-secondary" type="button" title="Buscar">ðŸ”Ž</button>
                    </div>
                    <div class="input-group-append">
                        <button id="newSearchButtonCliente" class="btn btn-outline-secondary" type="button" title="Nova Busca">ðŸª„</button>
                    </div>
                </div>
            </div> 
        {% else %}
        <div class="col"> 
            <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label> <br>
            {{ field }}
        </div>      
        {% endif %}
    {% endif %}        
    {% if field.name == 'aClient' or field.name == 'aDataPri' or field.name == 'aDifiPio' or field.name == 'aTrabRui' %}    
        </div> <br>
    {% endif %}
{% endfor %}
<script>
$(document).ready(function($){
    var client_select = $('#id_aClient');

    // condiÃ§Ãµes para liberaÃ§Ãµes de input e limpeza do campo select clientes
    var url_string = window.location.href; 
    var url = new URL(url_string);
    var afterLocalitionClient = url.searchParams.get("searchClient");
    if (!afterLocalitionClient){
        client_select.empty();
        var elements = document.querySelectorAll("input, select, checkbox, button, textarea");
        for (var i = 0; i < elements.length; i++) {
            elements[i].setAttribute("disabled", true);
        }
        $('#searchButtonCliente').prop("disabled", false);
        $('#input_aClient').prop("disabled", false);
    }else{
        $('#input_aClient').prop("disabled", true);
    }
    
    $('#searchButtonCliente').on('click', function(){
        var clientes;
        var cliente = $("#input_aClient").val();
        if(cliente!=''){
            clientes = $.ajax({
                url: "{% url 'atendimento:getJSONclient' %}?searchClient=" + cliente,   
                type: "get",     
                async: false,  
                data: $("#search").serialize(),    
                success: function (data){
                    data_clients = data.results 
                },                 
            });
        };
        if(clientes){
            $('#id_aClient').prop("disabled", false);
        }
        client_select.empty();
        var defaultOption = $('<option></option>').val('null').html('Selecione um cliente ...').prop('selected', true);
        client_select.append(defaultOption);
        for (const key in clientes.responseJSON.results){
            client_select.append(
                $('<option></option>').val(clientes.responseJSON.results[key].id).html(clientes.responseJSON.results[key].first_name + " " + clientes.responseJSON.results[key].last_name)
            );
        }
        
        $("#id_aClient").trigger('change');
    })

    $('#newSearchButtonCliente').on('click', function(){
        window.location.replace("{% url 'atendimento:atendimento' %}");
    })

    $('.navbar-toggler').prop("disabled", false);
})
</script>